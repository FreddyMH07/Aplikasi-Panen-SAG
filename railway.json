{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "composer install --no-dev && composer dump-autoload && npm ci && npm run build"
  },
  "deploy": {
  "startCommand": "bash -lc 'set -e; APP_NAME_RES=\"${APP_NAME:-Sistem Panen Sawit}\"; APP_URL_RES=\"${APP_URL:-https://example.com}\"; HOST_CANDIDATE=${DB_HOST:-${PGHOST:-${POSTGRES_HOST:-}}}; DB_NAME_RES=${DB_DATABASE:-${PGDATABASE:-${POSTGRES_DB:-railway}}}; DB_USER_RES=${DB_USERNAME:-${PGUSER:-${POSTGRES_USER:-postgres}}}; DB_PASS_RES=${DB_PASSWORD:-${PGPASSWORD:-${POSTGRES_PASSWORD:-}}}; DB_PORT_RES=${DB_PORT:-${PGPORT:-5432}}; SSL_MODE_RES=${PGSSLMODE:-require}; echo Building .env with host=$HOST_CANDIDATE; printf "APP_NAME=$APP_NAME_RES\nAPP_ENV=production\nAPP_KEY=${APP_KEY:-}\nAPP_URL=$APP_URL_RES\nAPP_TIMEZONE=Asia/Jakarta\nLOG_CHANNEL=stderr\nLOG_LEVEL=info\nFORCE_HTTPS=true\n\nDB_CONNECTION=pgsql\nDB_HOST=$HOST_CANDIDATE\nDB_PORT=$DB_PORT_RES\nDB_DATABASE=$DB_NAME_RES\nDB_USERNAME=$DB_USER_RES\nDB_PASSWORD=$DB_PASS_RES\nPGSSLMODE=$SSL_MODE_RES\nDB_CHARSET=utf8\n\nCACHE_DRIVER=file\nQUEUE_CONNECTION=sync\nSESSION_DRIVER=file\nSESSION_LIFETIME=120\nSESSION_SECURE_COOKIE=true\n\nMAIL_MAILER=log\n" > .env; if [ -z "$(grep '^APP_KEY=' .env | cut -d= -f2)" ]; then php artisan key:generate --force || true; fi; composer dump-autoload -o; echo ==== ENV DB SUMMARY ====; echo DB_HOST=$HOST_CANDIDATE DB_PORT=$DB_PORT_RES PGHOST=$PGHOST RAILWAY_PRIVATE_DOMAIN=$RAILWAY_PRIVATE_DOMAIN PGSSLMODE=$SSL_MODE_RES; if [ -n "$HOST_CANDIDATE" ]; then echo Using resolved DB host: $HOST_CANDIDATE; echo Waiting for Postgres host $HOST_CANDIDATE:$DB_PORT_RES ...; for i in $(seq 1 90); do (echo > /dev/tcp/$HOST_CANDIDATE/$DB_PORT_RES) >/dev/null 2>&1 && echo DB port open on $HOST_CANDIDATE && break || echo wait $i...; sleep 2; done; if [ $i -eq 90 ]; then echo Postgres not reachable after 180s on $HOST_CANDIDATE:$DB_PORT_RES; echo Skipping migrations.; else echo Running migrations...; php artisan migrate --force --no-interaction || { echo Migrate failed; exit 1; }; echo Seeding...; php artisan db:seed --force --no-interaction || true; fi; else echo No DB host provided, skipping migrations.; fi; php artisan config:cache; php artisan route:cache; php artisan view:cache; php artisan optimize:clear; php artisan serve --host=0.0.0.0 --port=$PORT'",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
